trigger: none   # Manual trigger only
pr: none

pool:
  name: PredatorAgentPool
  

variables:
  KUBE_NAMESPACE: 'portfolio'
  MANIFEST_PATH: 'main/k8s-manifests'  # Folder containing your manifests
  TLS_SECRET_NAME: 'portfolio-tls'

steps:

# Single combined step for LAN IP, TLS, and deployment
- script: |
    echo "=== Starting local deployment pipeline ==="

    # 1️⃣ Detect laptop LAN IP
    LAN_IP=$(hostname -I | awk '{print $1}')
    echo "Detected LAN IP: $LAN_IP"

    # 2️⃣ Update Ingress host in manifest
    echo "Updating Ingress host in manifest to LAN IP..."
    sed -i "s/host: .*/host: $LAN_IP/" $(MANIFEST_PATH)/portfolio-ingress.yaml

    # 3️⃣ Install mkcert if missing
    sudo apt-get update
    sudo apt-get install -y libnss3-tools
    mkcert -install || true

    # 4️⃣ Generate TLS cert for LAN IP
    if [ ! -f "${LAN_IP}.pem" ] || [ ! -f "${LAN_IP}-key.pem" ]; then
        echo "Generating mkcert TLS certificate for $LAN_IP..."
        mkcert $LAN_IP
    fi

    # 5️⃣ Create or update Kubernetes TLS secret
    kubectl --kubeconfig=$HOME/.kube/config get secret $(TLS_SECRET_NAME) -n $(KUBE_NAMESPACE) &> /dev/null
    if [ $? -eq 0 ]; then
        echo "Deleting existing TLS secret..."
        kubectl --kubeconfig=$HOME/.kube/config delete secret $(TLS_SECRET_NAME) -n $(KUBE_NAMESPACE)
    fi
    echo "Creating TLS secret..."
    kubectl --kubeconfig=$HOME/.kube/config create secret tls $(TLS_SECRET_NAME) \
        --cert=${LAN_IP}.pem \
        --key=${LAN_IP}-key.pem \
        -n $(KUBE_NAMESPACE)

    # 6️⃣ Apply all manifests
    echo "Applying all manifests from $(MANIFEST_PATH)..."
    kubectl --kubeconfig=$HOME/.kube/config apply -f $(MANIFEST_PATH) -n $(KUBE_NAMESPACE)

    # 7️⃣ Verify deployment
    echo "Deployment complete. Verifying resources..."
    kubectl --kubeconfig=$HOME/.kube/config get all -n $(KUBE_NAMESPACE)
    kubectl --kubeconfig=$HOME/.kube/config get ingress -n $(KUBE_NAMESPACE)
    echo "Your portfolio site should now be accessible at https://$LAN_IP"

  displayName: 'Deploy portfolio site with LAN IP + TLS'
