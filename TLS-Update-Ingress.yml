trigger: none   # Manual trigger only

pool:
  name: PredatorAgentPool   # Use your self-hosted agent pool
  

variables:
  KUBE_NAMESPACE: 'portfolio'
  MANIFEST_PATH: 'k8s'       # Folder containing Deployment, Service, Ingress YAMLs
  DOMAIN: 'portfolio.local'
  TLS_SECRET_NAME: 'portfolio-tls'

steps:

# 1️⃣ Checkout repo
- task: Checkout@1
  displayName: 'Checkout repository'

# 2️⃣ Install mkcert (for TLS)
- script: |
    sudo apt-get update
    sudo apt-get install -y libnss3-tools
    mkcert -install || true
  displayName: 'Install mkcert'

# 3️⃣ Detect laptop LAN IP
- script: |
    LAN_IP=$(hostname -I | awk '{print $1}')
    echo "##vso[task.setvariable variable=LAN_IP]$LAN_IP"
    echo "Detected LAN IP: $LAN_IP"
  displayName: 'Detect LAN IP'

# 4️⃣ Generate TLS certificate
- script: |
    if [ ! -f "$(DOMAIN).pem" ] || [ ! -f "$(DOMAIN)-key.pem" ]; then
      mkcert $(DOMAIN)
    fi
  displayName: 'Generate TLS certificate'

# 5️⃣ Create/Update Kubernetes TLS secret
- script: |
    kubectl --kubeconfig=$HOME/.kube/config get secret $(TLS_SECRET_NAME) -n $(KUBE_NAMESPACE) &> /dev/null
    if [ $? -eq 0 ]; then
      echo "Deleting existing TLS secret..."
      kubectl --kubeconfig=$HOME/.kube/config delete secret $(TLS_SECRET_NAME) -n $(KUBE_NAMESPACE)
    fi
    kubectl --kubeconfig=$HOME/.kube/config create secret tls $(TLS_SECRET_NAME) \
      --cert=$(DOMAIN).pem \
      --key=$(DOMAIN)-key.pem \
      -n $(KUBE_NAMESPACE)
  displayName: 'Create/Update TLS Secret'

# 6️⃣ Update Ingress host to LAN IP for network access
- script: |
    echo "Updating Ingress host to LAN IP $(LAN_IP) for LAN access..."
    sed -i "s/host: .*/host: $(LAN_IP)/" $(MANIFEST_PATH)/portfolio-ingress.yaml
  displayName: 'Update Ingress host to LAN IP'

# 7️⃣ Apply Kubernetes manifests
- script: |
    kubectl --kubeconfig=$HOME/.kube/config apply -f $(MANIFEST_PATH) -n $(KUBE_NAMESPACE)
  displayName: 'Apply Kubernetes Manifests'

# 8️⃣ Verify deployment
- script: |
    kubectl --kubeconfig=$HOME/.kube/config get all -n $(KUBE_NAMESPACE)
    kubectl --kubeconfig=$HOME/.kube/config get ingress -n $(KUBE_NAMESPACE)
    echo "Your portfolio site should now be accessible at https://$(LAN_IP)"
  displayName: 'Verify Deployment'
