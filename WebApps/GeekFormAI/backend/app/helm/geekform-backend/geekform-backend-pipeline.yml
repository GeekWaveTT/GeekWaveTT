trigger:
- none

pool:
  name:    PredatorAgentPool

variables:
- group: SQLDB   # links your library
- name: IMAGE_NAME
  value: geekform-backend:v1

steps:

# 1️⃣ Build Docker image
- task: Docker@2
  displayName: Build Docker image
  inputs:
    command: build
    Dockerfile: WebApps/GeekFormAI/backend/Dockerfile
    tags: |
      $(IMAGE_NAME)

# 2️⃣ Load the image into k3s (containerd) so pods can use it
- script: |
    echo "Loading Docker image into k3s..."
    docker save $(IMAGE_NAME) -o geekform-backend.tar
    sudo ctr -n k8s.io images import geekform-backend.tar
  displayName: Load Docker image into k3s

# 3️⃣ Deploy to k3s via Helm
- script: |
    echo "Deploying GeekForm backend to k3s..."
    cd WebApps/GeekFormAI/backend/app/helm/geekform-backend
    helm upgrade --install geekform . \
      --set postgres.password=$(POSTGRES_PASSWORD) \
      --set image.pullPolicy=Never
  displayName: Deploy via Helm
