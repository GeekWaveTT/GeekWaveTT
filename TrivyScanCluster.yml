trigger: none

pool:
  name: PredatorAgentPool  # your self-hosted agent with kubectl access

jobs:
- job: TrivyClusterScan
  displayName: "Scan all cluster images with Trivy"
  steps:
  - script: |
      echo "Installing Trivy..."
      sudo apt-get update -y
      sudo apt-get install -y wget apt-transport-https gnupg lsb-release

      wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
      echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list

      sudo apt-get update -y
      sudo apt-get install -y trivy

      echo "Getting all container images in cluster..."
      images=$(kubectl get pods --all-namespaces -o jsonpath="{..image}" | tr -s '[[:space:]]' '\n' | sort | uniq)

      echo "Images found:"
      echo "$images"

      mkdir -p trivy-reports

      for image in $images; do
        echo "Scanning $image ..."
        filename=$(echo $image | tr '/:' '__')
        trivy image --format json --output trivy-reports/$filename.json $image
      done

      echo "Scan complete. Reports saved in trivy-reports/"
    displayName: "Install Trivy and Scan Cluster Images"

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: 'trivy-reports'
      ArtifactName: 'TrivyScanReports'
      publishLocation: 'Container'
    displayName: "Publish Trivy Scan Reports"

